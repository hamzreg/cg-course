\chapter{Аналитическая часть}

В данном разделе рассматривается система, в которой происходит волновой процесс, состоящая из поверхности воды и предмета. Изучаются и сравниваются методы и алгоритмы, визуализирующие волны. В результате анализа определяется алгоритм, эффективно решающий задачу моделирования волн, образованных движением объекта.

\section{Волновой процесс}

Процесс образования волны \cite{airy} при условии, что частицы воды находятся в состоянии равновесия, состоит из следующих этапов:

\begin{itemize}
	\item на поверхность воды оказывается внешнее воздействие (ветер, движение корабля, падение камня), частицы жидкости опускаются вниз, водная поверхность становится вогнутой;
	\item сила тяжести или сила поверхностного натяжения стремятся вернуть частицы в состояние равновесия;
	\item частицы воды переходят положения равновесия, и поверхность воды становится выпуклой.
\end{itemize}

Движение передается от одних частиц к другим. Этапы волнового процесса показаны на рисунке \ref{img:wave-process}.

\begin{figure}[H]
	\begin{center}
		\includegraphics[scale=0.8]{img/wave-process.pdf}
	\end{center}
	\captionsetup{justification=centering}
	\caption{Процесс образования волны}
	\label{img:wave-process}
\end{figure}

Если восстановить равновесие стремится сила тяжести, то волны называются гравитационными, если сила поверхностного натяжения --- капиллярными. Волны называют капиллярно-гравитационными, когда силы сопоставимы.

\section{Модели предмета и волны}

Внешним воздействием в моделируемой системе является движение предмета.

\subsection{Модель предмета}

Для правильной обработки появления волн от твердого тела важны параметры только той части предмета, которая касается воды. В связи с этим нет необходимости рассматривать объект детально.

\subsection{Модель волны}

Геометрически волна состоит из следующих элементов:

\begin{itemize}
	\item гребень --- множество точек волны с максимальным положительным отклонением от состояния равновесия;
	\item подошва --- множество точек волны с наибольшим отрицательным отклонением от состояния равновесия.
\end{itemize}

Кроме того волна обладает следующими параметрами:

\begin{itemize}
	\item высота --- вертикальное расстояние от подошвы до гребня;
	\item длина --- горизонтальное расстояние от гребня до гребня;
	\item период --- временной интервал между прибытием последовательных гребней;
	\item частота --- величина, обратная периоду;
	\item амплитуда --- максимальное отклонение точек волны от положения равновесия;
	\item скорость распространения.
\end{itemize}

Модель волны показана на рисунке \ref{img:wave}.

\begin{figure}[H]
	\begin{center}
		\includegraphics[scale=0.8]{img/wave.pdf}
	\end{center}
	\captionsetup{justification=centering}
	\caption{Геометрическое строение волны}
	\label{img:wave}
\end{figure}

Параметры волны, показанные на рисунке \ref{img:math-wave}, обозначаются следующим образом:

\begin{itemize}
	\item $h(x,t)$ --- высота волны в положении $x$ в момент времени $t$;
	\item $\lambda$ --- длина;
	\item $T$ --- период;
	\item $\nu$ --- частота;
	\item $A$ --- амплитуда;
	\item $v$ --- скорость распространения.
\end{itemize}

\begin{figure}[H]
	\begin{center}
		\includegraphics[scale=0.8]{img/math-wave.pdf}
	\end{center}
	\captionsetup{justification=centering}
	\caption{График распространения волны}
	\label{img:math-wave}
\end{figure}

Распространение волн в среде \cite{airy} в общем случае описывается волновым уравнением:

\begin{equation}
    \label{wave-eq}
    \Delta h(x,t) = \frac{1}{v^2} \cdot \frac{\partial ^2h(x,t)}{\partial t^2}
\end{equation}

где $\Delta$ --- оператор Лапласа, $x \in \mathbb{R}^2$. 

Решением волнового уравнения \ref{wave-eq} является уравнение бегущей волны:

\begin{equation}
    \label{solution-wave-eq1}
    h(x,t) = A \cos \omega (t - \frac{x}{v})
\end{equation}

где $\omega$ --- циклическая частота, которая равняется

\begin{equation}
    \label{w}
    \omega = 2\pi \nu
\end{equation}

Можно ввести волновое число:

\begin{equation}
    \label{k1}
    k = \frac{2\pi}{\lambda}
\end{equation}

Вектор, абсолютное значение которого равно волновому числу, называют волновым вектором.

Длину волны $\lambda$ можно выразить следующей формулой:

\begin{equation}
    \label{l}
    \lambda = vT
\end{equation}

С учетом формул \ref{w} и \ref{l} формулу \ref{k1} можно записать так:

\begin{equation}
    \label{k2}
    k = \frac{2\pi}{vT} = \frac{2\pi \nu}{v} = \frac{\omega}{v}
\end{equation}

Отсюда скорость распространения волны:

\begin{equation}
    \label{speed}
    v = \frac{\omega}{k}
\end{equation}

Тогда уравнение бегущей волны \ref{solution-wave-eq1}:

\begin{equation}
    \label{solution-wave-eq2}
    h(x,t) = A \cos \omega (t - \frac{x}{v}) = A \cos (\omega t - \omega \frac{kx}{\omega}) = A \cos (\omega t - kx)
\end{equation}

При поглощении средой энергии волны наблюдается затухание волн. Поэтому уравнение бегущей волны принимает вид:

\begin{equation}
    \label{solution-wave-eq3}
    h(x,t) = A \exp(-\beta t) \cos (\omega t - kx)
\end{equation}

где $\beta$ --- коэффициент затухания.

\section{Дисперсионное соотношение}

Механизм образования волн подчиняется закону дисперсии.

Дисперсия волн --- это зависимость циклической частоты волны от волнового вектора:

\begin{equation}
    \label{dispersion}
    \omega = \omega (\vec{k})
\end{equation}

Соотношение означает, что волны разных длин перемещаются с разными фазовыми скоростями. Именно дисперсия создает сложную картину волн, образованных телом в воде.

В зависимости от требований к результату моделирования выбирается определенный метод визуализации. Так как в центре работы дисперсионные волны, для выполнения поставленных задач необходим такой метод моделирования, при котором выполняется дисперсионное соотношение.

\section{Методы визуализации волн}

Существует три группы методов моделирования волн:

\begin{itemize}
    \item процедурные;
    \item методы на основе частиц;
    \item метод поля высоты.
\end{itemize}

\subsection{Процедурные методы}

Идея процедурных методов заключается в представлении волновой поверхности наложением периодических функций: циклоиды в ранних работах \cite{cycloid} и синусоиды в дальнейших \cite{sin}. 

\begin{figure}[H]
	\begin{center}
		\includegraphics[scale=0.8]{img/procedure.pdf}
	\end{center}
	\captionsetup{justification=centering}
	\caption{Движение точки в процедурном методе}
	\label{img:procedure}
\end{figure}

На рисунке \ref{img:procedure} плоскость покоящейся волновой поверхности параллельна плоскости $XY$, ось $Z$ направлена вверх. Точка $p$ описывает окружность радиусом $\frac{1}{k}$ вокруг своего положения покоя --- точки $O$ с координатами $(x_{O}, y_{O}, z_{O})$. Точка $p$ находится на расстоянии $r$ от точки $O$. Тогда уравнение движения точки:

\begin{equation}
    \label{x}
    x = x_{O} + r\sin (kx_{O} - \omega t)
\end{equation}

\begin{equation}
    \label{z}
    z = z_{O} - r\cos (kx_{O} - \omega t)
\end{equation}

Волна --- траектория движения точки $p$. Для создания различных волновых эффектов изменяют параметры уравнений орбиты, например, радиус или фазовый угол $\alpha$.

Преимущество процедурных методов --- возможность точно контролировать движение волнового фронта --- поверхности воды, все точки которой движутся в одинаковой фазе.

Недостаток процедурных методов --- сложность получения правильного взаимодействия волн с погруженными телами и границами.  

\subsection{Методы на основе частиц}

В методах моделирования волновой поверхности на основе частиц \cite{sph} вода представляется как система частиц. Каждая частица $i$ имеет массу $m_{i}$ и обладает плотностью $\rho _{i}$, давлением $p_{i}$ и объемом $V_{i}$. С течением времени $t$ положение частицы $x_{i}$ и ее параметры меняются в соответствии с учетом скорости $v_{i}$:

\begin{equation}
    \label{vi}
    \frac{dx_{i}}{dt} = v_{i}
\end{equation}

Частицы движутся в потоке жидкости, поэтому скорость $v_{i}$ определяется формой Лагранжа уравнения Навье-Стокса:

\begin{equation}
    \label{dv}
    \frac{dv_{i}}{dt} = -\frac{1}{\rho _{i}} \nabla p_{i} + \nu \nabla ^2 v_{i} + \frac{F_{i}}{m_{i}}.
\end{equation}

где $\nu$ --- вязкость, $-\frac{1}{\rho _{i}} \nabla p_{i}$ описывает ускорение частиц из-за давления в жидкости, $\nu \nabla ^2 v_{i}$ --- ускорение, обусловленное силами трения между частицами с разными скоростями, $\frac{F_{i}}{m_{i}}$ --- другие ускорения, например ускорение свободного падения.

\begin{figure}[H]
	\begin{center}
		\includegraphics[scale=0.5]{img/particle.png}
	\end{center}
	\captionsetup{justification=centering}
	\caption{Моделирование при помощи метода на основе частиц}
	\label{img:particle}
\end{figure}

Число частиц интерполируется при помощи сглаживающей функции, которая является кубическим сплайном \cite{mps}.

Преимущество методов на основе частиц --- возможность добавлять и удалять расчетные точки во время моделирования.

Недостатки методов на основе частиц:
\begin{itemize}
	\item необходимость большого числа частиц для создания реалистичного изображения;
	\item создание неточных границ при контакте жидкости с твердым предметом или другой жидкостью.
\end{itemize} 

\subsection{Метод поля высоты}

В методе поля высоты \cite{heightfield} рассматривают волновое уравнение \ref{wave-eq}. Волновая поверхность представляется в виде двумерной функции --- поля высоты. Такое упрощение снижает вычислительные затраты. Поверхность дискретизируется в сетку, показанную на рисунке \ref{img:grid}, и определяется приблизительное решение в каждой точке сетки.

\begin{figure}[H]
	\begin{center}
		\includegraphics[scale=0.9]{img/grid.pdf}
	\end{center}
	\captionsetup{justification=centering}
	\caption{Представление волновой поверхности в виде сетки}
	\label{img:grid}
\end{figure}

Значение функции $h(x_{i,j})$ в точке сетки с координатам $(i,j)$ обозначается $z_{i,j}$. Оператор Лапласа в волновом уравнении:

\begin{equation}
    \label{laplace1}
    \Delta h(x_{i,j}) \approx \frac{z_{i+1,j} - 2z_{i,j} + z_{i-1,j}}{H^2} + \frac{z_{i,j+1} - 2z_{i,j} + z_{i,j-1}}{H^2}
\end{equation}

\begin{equation}
    \label{laplace2}
    \Delta h(x_{i,j}) = \frac{z_{i+1,j} + z_{i,j+1} - 4z_{i,j} + z_{i-1,j} + z_{i,j-1}}{H^2}
\end{equation}

где $H$ --- расстояние между двумя точками сетки.

Дискретизация времени обозначается $\Delta t$, значение точки с координатами $(i,j)$ в момент времени $t$ --- $z^t_{i,j}$. Тогда производная по времени в волновом уравнении:

\begin{equation}
    \label{second-derivative}
    \frac{\partial ^2h(x,t)}{\partial t^2} \approx \frac{z^{t+1}_{i,j} - 2z^t_{i,j} + z^{t-1}_{i,j}}{\Delta t^2}
\end{equation}

С учетом \ref{laplace2} и \ref{second-derivative} решение волнового уравнения:

\begin{equation}
    \label{1}
    \Delta h(x,t) - \frac{1}{v^2} \cdot \frac{\partial ^2h(x,t)}{\partial t^2} = 0
\end{equation}

\begin{equation}
    \label{2}
    \frac{z_{i+1,j} + z_{i,j+1} - 4z_{i,j} + z_{i-1,j} + z_{i,j-1}}{H^2} - \frac{1}{v^2} \frac{z^{t+1}_{i,j} - 2z^t_{i,j} + z^{t-1}_{i,j}}{\Delta t^2}
\end{equation}

\begin{equation}
    \label{3}
    z^{t+1}_{i,j} = \frac{v^2 \Delta t^2}{H^2} \cdot (z^t_{i+1,j} + z^t_{i,j+1} + z^t_{i-1,j} + z^t_{i,j-1}) + (2-4\frac{v^2 \Delta t^2}{H^2}) \cdot z^t_{i,j} - z^ {t-1}_{i,j}
\end{equation}

Преимущества метода поля высоты:

\begin{itemize}
	\item повышение скорости моделирования;
	\item точность обработки взаимодействия с препятствиями.
\end{itemize}

Недостатком метода поля высоты является невозможность создания обрушивающихся волн  из-за одинаковой скорости распространения всех волн.

Комбинация методов поля высоты и методов, основанных на частицах, позволяет обходить недостатки отдельных \cite{combine} и создавать различные эффекты.

\subsection*{Вывод}

В таблице \ref{tab:compare} представлено сравнение методов визуализации волн. Методы сравнивались по следующим критериям:

\begin{itemize}
	\item контроль волнового фронта (K1);
	\item реалистичность (K2);
	\item затраты памяти (K3);
	\item точность обработки взаимодействия с предметами (K4).
\end{itemize}

\begin{table}[h]
    \caption{Сравнение методов моделирования волн}
    \begin{center}
        \begin{tabular}{|l|l|l|l|l|}
            \hline
            Метод & K1 & K2 & K3 & K4 \\ \hline
            Процедурный & высокий & низкая & низкие & низкая \\ \hline
		    На основе частиц & высокий & высокая & высокие  & низкая \\ \hline
            Поля высоты & высокий & высокая & низкие & высокая  \\ \hline
        \end{tabular}
    \end{center}
    \label{tab:compare}
\end{table}

Процедурные метод и методы на основе частиц имеют сложности при работе с твердыми телами. Метод поля высот корректно обрабатывает взаимодействие с объектом, причем с более высокой скоростью моделирования. Недостатки метода поля высот не имеют значения при решении выбранной задачи. Моделирование волн будет реализовано при помощи метода поля высот.

\section{Методы рендеринга отображения}

Рендеринг или отрисовка --- процесс получения изображения по математической модели с помощью компьютерной программы.

Для моделирования волн был выбран метод поля высоты, в котором волновая поверхность представляется при помощи сетки. Высокая реалистичность изображения обеспечивается большим числом точек сетки. Для рендеринга поверхности воды не подходит стандартная графическая библиотека, так как в случае ее использования отрисовка займет длительное время. Для ускорения отрисовки необходимо выбрать API, которое позволяет использовать графический ускоритель для рендеринга изображения. Основными API являются DirectX, Vulkan и OpenGL.

\subsection{DirectX}

DirectX --- это API компьютерной графики от Microsoft, используемый для платформы Windows \cite{directx}. Инструмент более близок к архитектуре современных графических процессоров. DirectX фокусируется на рендеринге в реальном времени, поэтому он предназначен для разработчиков игр и систем автоматизированного проектирования.

Его преимущества:

\begin{itemize}
	\item быстрый рендеринг изображения;
	\item высокое качество изображения.
\end{itemize}

Недостатки API:

\begin{itemize}
	\item отсутствие поддержки старыми видеокартами;
	\item возможность использования только на операционных системах Windows.
\end{itemize}

\subsection{Vulkan}

Vulkan --- кроссплатформенный API для 2D- и 3D-графики, представленный Khronos Group \cite{vulkan}.

Инструмент обеспечивает высокую производительность при отображении в реальном времени различных приложений с 3D-графикой, таких как игры или интерактивные книги, на всех платформах.

Его преимущества:

\begin{itemize}
	\item открытый исходный код;
	\item высокая производительность работы;
	\item кроссплатформенность.
\end{itemize}

Недостатки API:

\begin{itemize}
	\item прямая работа с GPU;
	\item отсутствие библиотек для некоторых языков программирования.
\end{itemize}

\subsection{OpenGL}

OpenGL --- API, предоставляющий большой набор функций, которые можно использовать для управления графикой и изображениями \cite{directx}. OpenGL является спецификацией, разработанной и поддерживаемой Khronos Group.

Спецификация OpenGL определяет, каким должен быть результат работы каждой функции, и каким образом функция должна выполняться. Реализация спецификации зависит от разработчика.

Графическая обработка осуществляется при помощи графического конвейера. Работу конвейера можно разделить на несколько этапов, где каждый следующий этап в качестве входных данных использует выходные данные из предыдущего этапа. Все эти этапы имеют только одну конкретную функцию и могут легко выполняться параллельно. На каждом этапе запускается программа на графическом процессоре, называемая шейдером. Некоторые шейдеры могут быть изменены разработчиком, что дает возможность более точного контроля над работой конвейера.

Этапы работы графического конвейера:

\begin{itemize}
	\item вершинный шейдер обрабатывает 3D-координаты вершины;
	\item все вершины из вершинного шейдера собираются в заданной для примитива форме;
	\item геометрический шейдер принимает в качестве входных данных набор вершин, образующих примитив, и добавляет дополнительные вершины для формирования других примитивов.
	\item выходные данные геометрического шейдера передаются на этап растеризации, на котором результирующие примитивы сопоставляются с соответствующими пикселями на экране;
	\item фрагментный шейдер вычисляет конечный цвет пикселя.
\end{itemize}

Преимущества OpenGL:

\begin{itemize}
	\item высокая производительность работы;
	\item возможность изменения параметров выводимых объектов;
	\item кроссплатформенность;
	\item наличие библиотек для работы с различными языками программирования.
\end{itemize}

Его недостатки:
\begin{itemize}
	\item сложность работы с новыми возможностями GPU;
	\item необходимость отдельных инструментов для работы с устройствами ввода.
\end{itemize}

\subsection*{Вывод}

В таблице \ref{tab:opengl} представлено сравнение методов рендеринга изображения. Методы сравнивались по следующим критериям:

\begin{itemize}
	\item наличие библиотеки для работы с языком программирования Python (K1);
	\item открытый код (K2);
	\item кроссплатформенность (K3).
\end{itemize}

\begin{table}[h]
    \caption{Сравнение методов рендеринга изображения}
    \begin{center}
        \begin{tabular}{|l|l|l|l|}
            \hline
            Метод & K1 & K2 & K3 \\ \hline
            DirectX & + & - & - \\ \hline
		    Vulkan & - & + & + \\ \hline
            OpenGL & + & + & + \\ \hline
        \end{tabular}
    \end{center}
    \label{tab:opengl}
\end{table}

Из результатов сравнения методов рендеринга изображений можно сделать вывод о том, что для рендеринга модели волнового процесса будет использоваться OpenGL.

\section{Существующие программные \newline обеспечения}

Одним из популярных программных обеспечений для моделирования жидкости, в том числе и волн, является расширение Blender \cite{blender} --- Mantaflow \cite{mantaflow}. В этом программном продукте существует возможность реализовать моделирование линейных волн, гибкие системы частиц, различные эффекты для жидкости, например, поверхностную турбулентность и вейвлет (небольшую рябь). На рисунке \ref{img:mantaflow} показано моделирование волн в Mantaflow. 

\begin{figure}[H]
	\begin{center}
		\includegraphics[scale=0.2]{img/mantaflow.png}
	\end{center}
	\captionsetup{justification=centering}
	\caption{Моделирование волн в среде Mantaflow в Blender}
	\label{img:mantaflow}
\end{figure}

В коммерческих и научных проектах используется FLOW-3D \cite{flow-3d}, который представляет набор инструментов для моделирования жидкостей, с целью исследования динамики их движения. Данный пакет позволяет моделировать линейные и нелинейные распространяющиеся поверхностные волны. На рисунке \ref{img:flow-3d} показаны линейный волны, визуализированные в FLOW-3D.

\begin{figure}[H]
	\begin{center}
		\includegraphics[scale=0.2]{img/flow-3d.png}
	\end{center}
	\captionsetup{justification=centering}
	\caption{Моделирование волн при помощи пакета FLOW-3D}
	\label{img:flow-3d}
\end{figure}

\section*{Вывод}

В ходе изучения волнового процесса были рассмотрены модели волны и предмета. Было проведено сравнение методов и алгоритмов, моделирующих волны. В качестве метода визуализации был выбран метод поля высоты, в качестве метода рендеринга изображения --- OpenGL.